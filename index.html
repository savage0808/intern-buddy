<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intern Buddy Pro ‚Äî Roche Malaysia</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ VARIABLES ‚îÄ‚îÄ */
:root {
  --blue:#005faa; --blue2:#003d7a; --blue-lt:#e8f2fb; --blue-mid:#b8d8f0;
  --ink:#0f172a; --ink2:#1e293b; --ink3:#334155;
  --slate:#475569; --muted:#94a3b8; --border:#e2e8f0; --border2:#f1f5f9;
  --surface:#f8fafc; --surface2:#f1f5f9; --white:#ffffff;
  --green:#059669; --red:#dc2626; --amber:#d97706;
  /* keep purple vars so JS block styles work */
  --purple:var(--blue); --purple2:var(--blue2);
  --shlg: 0 1px 3px rgba(0,0,0,.07), 0 8px 24px rgba(0,0,0,.08);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:#eef2f7;min-height:100vh;color:var(--ink);font-size:14px;}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
.loading-screen{position:fixed;inset:0;background:var(--ink);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;z-index:999;}
.loading-spinner{width:40px;height:40px;border:3px solid rgba(0,95,170,.25);border-top-color:var(--blue);border-radius:50%;animation:spin .75s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-txt{color:rgba(255,255,255,.45);font-size:.82rem;}

/* ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ */
.config-screen{position:fixed;inset:0;background:var(--ink);display:flex;align-items:center;justify-content:center;padding:24px;z-index:998;}
.config-card{background:var(--white);border-radius:16px;padding:32px;width:100%;max-width:520px;box-shadow:0 24px 60px rgba(0,0,0,.25);max-height:90vh;overflow-y:auto;}
.config-title{font-size:1.1rem;font-weight:800;color:var(--ink);margin-bottom:6px;}
.config-sub{font-size:.84rem;color:var(--muted);margin-bottom:18px;line-height:1.6;}
.config-step{background:var(--surface);border-left:3px solid var(--blue);padding:10px 14px;border-radius:0 8px 8px 0;font-size:.81rem;color:var(--ink3);margin-bottom:8px;line-height:1.65;}
.config-step code{background:var(--blue-lt);color:var(--blue2);padding:2px 6px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:.76rem;}
.config-field{margin-bottom:12px;}
.config-field label{display:block;font-size:.7rem;font-weight:700;color:var(--slate);margin-bottom:4px;text-transform:uppercase;letter-spacing:.07em;}
.config-field input{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:.85rem;font-family:'JetBrains Mono',monospace;color:var(--ink);outline:none;transition:border .15s;}
.config-field input:focus{border-color:var(--blue);}
.config-err{color:var(--red);font-size:.78rem;margin-top:8px;display:none;}

/* ‚îÄ‚îÄ SAVING PILL ‚îÄ‚îÄ */
.saving-pill{position:fixed;top:18px;right:24px;background:var(--blue);color:#fff;padding:6px 14px;border-radius:20px;font-size:.72rem;font-weight:600;z-index:999;opacity:0;transition:opacity .3s;pointer-events:none;}
.saving-pill.show{opacity:1;}

/* ‚îÄ‚îÄ APP SHELL ‚Äî desktop layout ‚îÄ‚îÄ */
#appShell{display:none;}

/* Topbar fixed at top */
.topbar{
  position:fixed;top:0;left:0;right:0;height:58px;
  background:var(--ink);
  display:flex;align-items:center;padding:0 28px;gap:16px;
  z-index:100;box-shadow:0 2px 16px rgba(0,0,0,.3);
}
.topbar-brand{display:flex;align-items:center;gap:14px;}
.topbar-roche-img{height:28px;width:auto;filter:brightness(0) invert(1);display:block;}
.topbar-sep{width:1px;height:22px;background:rgba(255,255,255,.15);flex-shrink:0;}
.topbar-appname{color:rgba(255,255,255,.9);font-size:.88rem;font-weight:700;}
.topbar-sub{color:rgba(255,255,255,.4);font-size:.7rem;font-weight:500;}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:12px;}
.conn-badge{display:flex;align-items:center;gap:6px;color:var(--green);font-size:.73rem;font-weight:600;}
.conn-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite;display:inline-block;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.35;}}
.hdr-badge{background:rgba(0,95,170,.35);color:#93c5fd;font-size:.68rem;font-weight:700;padding:4px 10px;border-radius:6px;border:1px solid rgba(0,95,170,.4);}
.logout-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.75);font-size:.78rem;padding:7px 15px;border-radius:8px;cursor:pointer;font-family:inherit;font-weight:600;transition:all .15s;}
.logout-btn:hover{background:rgba(255,255,255,.16);border-color:rgba(255,255,255,.3);}

/* Sidebar fixed on left */
.app-sidebar{
  position:fixed;top:58px;left:0;bottom:0;width:220px;
  background:var(--white);border-right:1px solid var(--border);
  overflow-y:auto;padding:20px 10px;z-index:90;
}
.sidebar-label{font-size:.64rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);padding:0 10px;margin-bottom:6px;display:block;margin-top:4px;}
.sidebar-sep{height:1px;background:var(--border2);margin:12px 0;}
.snav-btn{
  display:flex;align-items:center;gap:9px;width:100%;
  padding:9px 10px;border-radius:8px;border:none;background:none;
  font-family:'Inter',sans-serif;font-size:.84rem;font-weight:600;color:var(--ink3);
  cursor:pointer;text-align:left;transition:all .12s;margin-bottom:2px;
}
.snav-btn:hover{background:var(--surface2);}
.snav-btn.active{background:var(--blue-lt);color:var(--blue2);}
.snav-icon{width:28px;height:28px;border-radius:7px;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;transition:background .12s;}
.snav-btn.active .snav-icon{background:var(--blue);color:#fff;}

/* Main content area - offset for topbar + sidebar */
.app-main{
  position:fixed;top:58px;left:220px;right:0;bottom:0;
  overflow-y:auto;padding:32px 40px;background:#eef2f7;
}

/* ‚îÄ‚îÄ SHELL / CARD ‚Äî override old phone styles ‚îÄ‚îÄ */
.shell{width:100%;max-width:none !important;}
.card{
  background:transparent !important;
  border-radius:0 !important;
  box-shadow:none !important;
  display:block !important;
  max-height:none !important;
  overflow:visible !important;
}
.hdr{display:none !important;}  /* hide old dark header ‚Äî topbar replaces it */

/* ‚îÄ‚îÄ VIEW system ‚îÄ‚îÄ */
.view{display:none;animation:fi .18s ease;}
.view.active{display:block;}
@keyframes fi{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}

/* ‚îÄ‚îÄ LOGIN ‚Äî full screen overlay ‚îÄ‚îÄ */
#v-login{
  position:fixed !important;
  inset:0 !important;
  display:none !important;
  z-index:50;
  background:linear-gradient(135deg,#0f172a 0%,#0a2040 100%);
  align-items:center;
  justify-content:center;
  padding:24px;
}
#v-login.active{display:flex !important;}
.login-panel{
  display:grid;grid-template-columns:1.1fr 1fr;
  background:var(--white);border-radius:18px;overflow:hidden;
  width:100%;max-width:860px;
  box-shadow:0 32px 80px rgba(0,0,0,.35);min-height:480px;
}
.login-left{
  background:linear-gradient(160deg,#0a1628 0%,#0d2244 60%,#0a3060 100%);
  padding:52px 48px;
  display:flex;flex-direction:column;justify-content:space-between;
  position:relative;overflow:hidden;
}
/* glowing orbs */
.login-left::before{content:'';position:absolute;top:-60px;right:-80px;width:400px;height:400px;background:radial-gradient(circle,rgba(0,102,204,.4) 0%,transparent 65%);pointer-events:none;}
.login-left::after{content:'';position:absolute;bottom:-100px;left:-60px;width:320px;height:320px;background:radial-gradient(circle,rgba(0,60,140,.35) 0%,transparent 65%);pointer-events:none;}
/* animated shimmer line */
.login-left-shimmer{position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(0,120,255,.8),transparent);animation:shimmer 3s ease-in-out infinite;pointer-events:none;}
@keyframes shimmer{0%,100%{opacity:.3;transform:scaleX(.4);}50%{opacity:1;transform:scaleX(1);}}
.login-branding{position:relative;z-index:1;}
.login-roche-img{
  height:44px;width:auto;
  filter:brightness(0) invert(1);
  display:block;
  margin-bottom:52px;
  opacity:.9;
}
.login-intern-buddy{
  font-size:5.2rem;font-weight:900;color:#fff;
  line-height:.9;letter-spacing:-.05em;
  margin-bottom:18px;
  background:linear-gradient(135deg,#fff 40%,#7fb8ff 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}
.login-intern-sub{
  font-size:.82rem;font-weight:700;
  color:rgba(255,255,255,.4);
  letter-spacing:.18em;text-transform:uppercase;
}
.login-footer-txt{font-size:.7rem;color:rgba(255,255,255,.22);position:relative;z-index:1;letter-spacing:.04em;}
.login-right{padding:48px;display:flex;flex-direction:column;justify-content:center;}
.login-form-title{font-size:1.2rem;font-weight:800;color:var(--ink);margin-bottom:4px;}
.login-form-sub{font-size:.84rem;color:var(--muted);margin-bottom:28px;}
.login-icon{display:none;} /* hide old phone icon */
.login-title,.login-sub{display:none;} /* hide old titles ‚Äî replaced */

/* ‚îÄ‚îÄ FORM FIELDS ‚îÄ‚îÄ */
.field{margin-bottom:16px;}
.field label{display:block;font-size:.7rem;font-weight:700;color:var(--slate);margin-bottom:5px;text-transform:uppercase;letter-spacing:.07em;}
.field input{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:9px;font-size:.9rem;font-family:inherit;color:var(--ink);outline:none;transition:border .15s;background:var(--surface);}
.field input:focus{border-color:var(--blue);background:#fff;box-shadow:0 0 0 3px rgba(0,95,170,.1);}
.btn-login{width:100%;padding:13px;background:var(--blue);color:#fff;border:none;border-radius:10px;font-size:.95rem;font-weight:700;cursor:pointer;font-family:inherit;transition:all .18s;}
.btn-login:hover{background:var(--blue2);transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,95,170,.35);}
.login-err{color:var(--red);font-size:.82rem;text-align:center;margin-top:10px;display:none;}

/* ‚îÄ‚îÄ MAIN MENU ‚îÄ‚îÄ */
.section-title{font-size:.67rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:14px;}
.view-header{margin-bottom:28px;}
.view-title{font-size:1.35rem;font-weight:800;color:var(--ink);letter-spacing:-.02em;}
.view-subtitle{font-size:.84rem;color:var(--muted);margin-top:4px;}
.main-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
.menu-card{background:var(--white);border:1.5px solid var(--border);border-radius:14px;padding:22px 18px;cursor:pointer;transition:all .15s;text-align:left;width:100%;box-shadow:var(--shlg);}
.menu-card:hover{border-color:var(--blue);background:var(--blue-lt);transform:translateY(-2px);box-shadow:0 6px 24px rgba(0,95,170,.14);}
.menu-card:active{transform:translateY(0);}
.menu-card-icon{font-size:28px;margin-bottom:12px;display:block;}
.menu-card-title{font-size:.88rem;font-weight:700;color:var(--ink);line-height:1.35;}

/* ‚îÄ‚îÄ CONTENT BLOCKS ‚îÄ‚îÄ */
.content-card{background:var(--white);border-radius:14px;padding:32px;border:1px solid var(--border);box-shadow:var(--shlg);max-width:760px;}
.block-heading{font-size:1.1rem;font-weight:800;color:var(--ink);margin-bottom:12px;line-height:1.3;letter-spacing:-.01em;}
.block-text{font-size:.88rem;color:var(--slate);line-height:1.7;margin-bottom:12px;}
.instruction-step{background:var(--blue-lt);border-left:4px solid var(--blue);padding:12px 16px;border-radius:0 10px 10px 0;font-size:.88rem;color:var(--ink3);margin-bottom:10px;line-height:1.6;}
.senior-alert{background:#fffbeb;border:1.5px solid #fbbf24;border-radius:10px;padding:12px 16px;font-size:.88rem;font-weight:700;color:#92400e;margin-bottom:12px;}
.link-card{display:flex;align-items:center;gap:12px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;padding:13px 16px;text-decoration:none;color:var(--ink);font-size:.88rem;font-weight:600;margin-bottom:10px;transition:all .15s;}
.link-card:hover{border-color:var(--blue);background:var(--blue-lt);color:var(--blue);}
.senior-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px;}
.senior-box{display:flex;flex-direction:column;align-items:center;gap:6px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;padding:16px 8px;text-decoration:none;color:var(--ink3);font-size:.75rem;font-weight:600;transition:all .15s;}
.senior-box:hover{border-color:var(--blue);background:var(--blue-lt);}
.senior-box img{width:44px;height:44px;border-radius:50%;}
.block-code{background:#0f172a;color:#93c5fd;font-family:'JetBrains Mono',monospace;font-size:.83rem;padding:16px 18px;border-radius:10px;margin-bottom:12px;white-space:pre-wrap;word-break:break-all;line-height:1.6;}
.block-image{width:100%;border-radius:10px;margin-bottom:6px;object-fit:cover;display:block;}
.block-caption{font-size:.75rem;color:var(--muted);text-align:center;margin-bottom:12px;font-style:italic;}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;justify-content:center;padding:11px 20px;border:none;border-radius:9px;font-size:.88rem;font-weight:700;cursor:pointer;font-family:inherit;margin-bottom:8px;margin-right:6px;transition:all .15s;}
.btn-p{background:var(--blue);color:#fff;box-shadow:0 2px 8px rgba(0,95,170,.2);}
.btn-p:hover{background:var(--blue2);transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,95,170,.3);}
.btn-g{background:var(--surface);color:var(--ink3);border:1.5px solid var(--border);}
.btn-g:hover{border-color:var(--blue);color:var(--blue);background:var(--blue-lt);}
.btn-r{background:var(--red);color:#fff;}
.btn-r:hover{background:#b91c1c;}
.btn-s{background:var(--green);color:#fff;}
.btn-s:hover{background:#047857;}
.btn-sm{padding:8px 14px;font-size:.8rem;}

/* ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ */
.adm-layout-wrap{display:grid;grid-template-columns:180px 1fr;gap:20px;align-items:start;}
.adm-sidebar-box{background:var(--white);border-radius:12px;border:1px solid var(--border);overflow:hidden;box-shadow:var(--shlg);position:sticky;top:0;}

/* Override old horizontal flex for adm-nav ‚Üí make it vertical */
.adm-nav{
  display:flex !important;
  flex-direction:column !important;
  border-bottom:none !important;
  padding:8px;
  background:none;
}
.adm-tab{
  display:flex;align-items:center;gap:8px;
  padding:10px 12px;border-radius:8px;cursor:pointer;
  color:var(--muted);font-size:.84rem;font-weight:600;
  transition:all .12s;width:100%;text-align:left;
  border-bottom:none !important;border:none;background:none;font-family:inherit;
  margin-bottom:2px;
}
.adm-tab:hover{background:var(--surface2);color:var(--ink);}
.adm-tab.on{background:var(--blue-lt);color:var(--blue2);font-weight:700;}

.adm-body-box{background:var(--white);border-radius:12px;border:1px solid var(--border);box-shadow:var(--shlg);}
.adm-sec{display:none;padding:28px;}
.adm-sec.on{display:block;}
.adm-sec-title{font-size:1rem;font-weight:800;color:var(--ink);margin-bottom:4px;}
.adm-sec-sub{font-size:.82rem;color:var(--muted);margin-bottom:20px;}

/* Keep max-height:none on adm-sec since we use page scroll */
.adm-sec.on{max-height:none !important;}

.stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px;}
.stat-card{background:linear-gradient(135deg,var(--blue-lt),#fff);border:1.5px solid var(--blue-mid);border-radius:12px;padding:20px;text-align:center;}
.stat-num{font-size:2rem;font-weight:800;color:var(--blue);letter-spacing:-.04em;}
.stat-lbl{font-size:.7rem;color:var(--muted);margin-top:4px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;}
.save-banner{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1.5px solid #86efac;border-radius:12px;padding:14px 18px;margin-bottom:18px;display:flex;align-items:flex-start;gap:12px;}
.save-banner strong{display:block;font-size:.88rem;color:#166534;margin-bottom:2px;}
.save-banner span{font-size:.78rem;color:#15803d;line-height:1.5;}
.adm-list-item{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--surface);border:1.5px solid var(--border);border-radius:12px;margin-bottom:8px;transition:border .12s;}
.adm-list-item:hover{border-color:var(--blue-mid);}
.adm-item-icon{width:42px;height:42px;border-radius:10px;background:var(--blue-lt);display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0;}
.adm-item-info{flex:1;min-width:0;}
.adm-item-title{font-size:.9rem;font-weight:700;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.adm-item-id{font-size:.73rem;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:2px;}
.adm-item-acts{display:flex;gap:6px;flex-shrink:0;}
.act-btn{width:34px;height:34px;border-radius:8px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.85rem;transition:all .12s;}
.act-btn:hover{border-color:var(--blue);color:var(--blue);background:var(--blue-lt);}
.act-btn.del:hover{border-color:var(--red);color:var(--red);background:#fef2f2;}
.sec-box{background:var(--surface);border:1.5px solid var(--border);border-radius:12px;padding:20px;margin-bottom:14px;}
.sec-box-title{font-size:.88rem;font-weight:700;color:var(--ink);margin-bottom:14px;}
.hash-note{background:var(--blue-lt);border:1.5px solid var(--blue-mid);border-radius:10px;padding:13px 16px;font-size:.8rem;color:var(--blue2);margin-bottom:16px;line-height:1.6;}

/* ‚îÄ‚îÄ MODALS ‚Äî centered dialog ‚îÄ‚îÄ */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity .2s;padding:24px;}
.modal-bg.open{opacity:1;pointer-events:all;}
.modal{background:var(--white);border-radius:16px;width:100%;max-width:660px;max-height:88vh;overflow-y:auto;transform:scale(.96) translateY(12px);transition:transform .25s cubic-bezier(.32,1,.45,1);padding:28px;box-shadow:0 24px 60px rgba(0,0,0,.2);}
.modal-bg.open .modal{transform:scale(1) translateY(0);}
.modal-handle{display:none;}
.modal-title{font-size:1.05rem;font-weight:800;color:var(--ink);margin-bottom:18px;}
.btp{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:14px;}
.btp-btn{background:var(--surface);border:1.5px solid var(--border);border-radius:9px;padding:10px 4px;cursor:pointer;text-align:center;transition:all .12s;}
.btp-btn:hover,.btp-btn.sel{border-color:var(--blue);background:var(--blue-lt);}
.btp-btn .ico{font-size:16px;display:block;margin-bottom:4px;}
.btp-btn .lbl{font-size:.67rem;font-weight:700;color:var(--ink3);}
.btp-btn.sel .lbl{color:var(--blue2);}
.bfe{background:var(--surface);border:1.5px solid var(--border);border-radius:10px;padding:14px;margin-bottom:12px;}
.bfe-title{font-size:.7rem;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:.07em;margin-bottom:10px;}
.bfe input,.bfe textarea,.bfe select{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:.88rem;font-family:inherit;color:var(--ink);outline:none;margin-bottom:8px;background:var(--white);}
.bfe input:focus,.bfe textarea:focus,.bfe select:focus{border-color:var(--blue);}
.bfe textarea{resize:vertical;min-height:80px;}
.blk-editor{margin-bottom:14px;}
.blk-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--surface);border:1.5px solid var(--border);border-radius:9px;margin-bottom:6px;}
.blk-badge{font-size:.65rem;font-weight:700;padding:3px 8px;border-radius:5px;background:var(--blue-lt);color:var(--blue2);flex-shrink:0;text-transform:uppercase;}
.blk-prev{font-size:.8rem;color:var(--slate);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.blk-acts{display:flex;gap:4px;flex-shrink:0;}
.bact{width:26px;height:26px;border-radius:6px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-size:.75rem;display:flex;align-items:center;justify-content:center;transition:all .12s;}
.bact:hover{border-color:var(--blue);color:var(--blue);}
.bact.bad:hover{border-color:var(--red);color:var(--red);}
.blk-empty{font-size:.82rem;color:var(--muted);text-align:center;padding:18px;font-style:italic;background:var(--surface);border-radius:8px;border:1.5px dashed var(--border);}
.prev-lbl{font-size:.68rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px;}
.prev-box{background:var(--surface);border:1.5px dashed var(--border);border-radius:10px;padding:14px;min-height:60px;}
.cnt-row{display:grid;grid-template-columns:1fr 1fr 32px;gap:8px;align-items:center;margin-bottom:8px;}
.cnt-del{height:32px;border:1.5px solid var(--border);background:var(--white);border-radius:7px;cursor:pointer;color:var(--red);display:flex;align-items:center;justify-content:center;font-size:.85rem;}
.cnt-del:hover{background:#fef2f2;border-color:var(--red);}
.img-upload-box{border:2px dashed var(--border);border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:all .15s;background:var(--surface);}
.img-upload-box:hover{border-color:var(--blue);background:var(--blue-lt);}
.img-upload-box input[type=file]{display:none;}
.img-preview{width:100%;max-height:180px;object-fit:cover;border-radius:8px;margin-top:10px;display:none;}
.img-uploading{color:var(--blue);font-size:.82rem;margin-top:8px;display:none;font-weight:600;}
.confirm-body{text-align:center;padding:12px 0;}
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--ink);color:#fff;padding:11px 22px;border-radius:24px;font-size:.84rem;font-weight:600;z-index:999;transition:transform .3s cubic-bezier(.32,1,.45,1);white-space:nowrap;box-shadow:0 8px 24px rgba(0,0,0,.2);}
.toast.show{transform:translateX(-50%) translateY(0);}
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--muted);}
</style>
</head>
<body>

<!-- Loading / config screens ‚Äî same as original, no change -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-spinner"></div>
  <div class="loading-txt" id="loadingTxt">Connecting to Firebase‚Ä¶</div>
</div>

<div class="config-screen" id="configScreen" style="display:none">
  <div class="config-card">
    <div style="font-size:32px;margin-bottom:10px">üî•</div>
    <div class="config-title">Connect to Firebase</div>
    <div class="config-sub">One-time setup. Your Firebase config is saved in this browser only.</div>
    <div class="config-step">1. Go to <strong>console.firebase.google.com</strong> ‚Üí create a project named <code>intern-buddy</code></div>
    <div class="config-step">2. <strong>Build ‚Üí Realtime Database</strong> ‚Üí Create database ‚Üí <code>Start in test mode</code></div>
    <div class="config-step">3. <strong>Project Settings ‚öôÔ∏è ‚Üí Your apps ‚Üí Add web app</strong> ‚Üí copy values below</div>
    <div class="config-step">4. In <strong>Realtime Database ‚Üí Rules</strong>: paste <code>{"rules":{".read":"auth == null || auth != null",".write":"auth == null || auth != null"}}</code> ‚Üí Publish</div>
    <div class="config-field"><label>Database URL</label><input id="cfg-url" placeholder="https://intern-buddy-xxxxx-default-rtdb.firebaseio.com"></div>
    <div class="config-field"><label>API Key</label><input id="cfg-key" placeholder="AIzaSy..."></div>
    <div class="config-field"><label>Project ID</label><input id="cfg-pid" placeholder="intern-buddy-xxxxx"></div>
    <div class="config-err" id="cfg-err">Please fill in all three fields.</div>
    <button class="btn btn-p" style="margin-top:14px;width:100%;padding:13px" onclick="saveConfig()">Connect & Launch ‚Üí</button>
  </div>
</div>

<div class="saving-pill" id="savingPill">‚òÅÔ∏è Saving‚Ä¶</div>

<!-- ‚ïê‚ïê APP SHELL ‚ïê‚ïê -->
<div id="appShell">

  <!-- TOPBAR (hidden until JS shows it via CSS class) -->
  <div class="topbar" id="appTopbar" style="display:none">
    <div class="topbar-brand">
      <img src="https://upload.wikimedia.org/wikipedia/commons/f/f5/Hoffmann-La_Roche_logo.svg" class="topbar-roche-img" alt="Roche">
      <div class="topbar-sep"></div>
      <div>
        <div class="topbar-appname">Intern Buddy Pro</div>
        <div class="topbar-sub">IT Operations Hub ¬∑ Roche Malaysia</div>
      </div>
    </div>
    <div class="topbar-right">
      <div class="conn-badge"><span class="conn-dot"></span>Firebase Live</div>
      <div id="hdrRight"><span class="hdr-badge">v5 ¬∑ Firebase</span></div>
    </div>
  </div>

  <!-- SIDEBAR (hidden until login) -->
  <div class="app-sidebar" id="appSidebar" style="display:none">
    <span class="sidebar-label">Navigation</span>
    <button class="snav-btn" data-nav="main" onclick="window.showView&&window.showView('main')">
      <div class="snav-icon">üè†</div>Home
    </button>
    <div id="sidebarItems"></div>
    <div class="sidebar-sep"></div>
    <span class="sidebar-label">System</span>
    <button class="snav-btn" id="sidebarAdminBtn" style="display:none" data-nav="admin" onclick="window.showView&&window.showView('admin')">
      <div class="snav-icon">‚öôÔ∏è</div>Admin Panel
    </button>
  </div>

  <!-- MAIN CONTENT (offset by topbar+sidebar after login) -->
  <div id="appMain" style="padding:0">

    <!-- The JS-controlled .shell and .card -->
    <div class="shell">
      <div class="card">

        <!-- JS writes to these (hidden in desktop) -->
        <div class="hdr" style="display:none">
          <div class="hdr-top">
            <span class="hdr-logo">Intern Buddy Pro</span>
            <div id="hdrRightOLD"></div>
          </div>
          <div class="hdr-body">
            <div class="hdr-title" id="hTitle">Operations Hub</div>
            <div class="hdr-sub" id="hSub"></div>
          </div>
        </div>

        <!-- dynViews ‚Äî JS injects sub-views here -->
        <div id="dynViews"></div>

        <!-- LOGIN VIEW -->
        <div class="view active" id="v-login">
          <div class="login-panel">
            <div class="login-left">
              <div class="login-left-shimmer"></div>
              <div class="login-branding">
                <img src="https://upload.wikimedia.org/wikipedia/commons/f/f5/Hoffmann-La_Roche_logo.svg" class="login-roche-img" alt="Roche">
                <div class="login-intern-buddy">Intern<br>Buddy</div>
                <div class="login-intern-sub">IT Operations Hub</div>
              </div>
              <div class="login-footer-txt">Roche Malaysia ¬∑ IT Department ¬∑ Internal Tool</div>
            </div>
            <div class="login-right">
              <div class="login-form-title">Welcome back üëã</div>
              <div class="login-form-sub">Sign in to continue to Intern Buddy</div>
              <div class="field"><label>Username</label><input id="l-user" placeholder="Enter your username" autocomplete="username"></div>
              <div class="field"><label>Password</label><input id="l-pass" type="password" placeholder="Enter your password" autocomplete="current-password"></div>
              <button class="btn-login" onclick="doLogin()">Sign In ‚Üí</button>
              <div class="login-err" id="loginErr">Incorrect username or password.</div>
            </div>
          </div>
        </div>

        <!-- MAIN MENU VIEW -->
        <div class="view" id="v-main">
          <div style="margin-bottom:6px;font-size:1.3rem;font-weight:800;color:var(--ink);letter-spacing:-.02em">Operations Hub</div>
          <div style="font-size:.84rem;color:var(--muted);margin-bottom:24px">Select a category to get started</div>
          <div class="section-title">Quick Actions</div>
          <div class="main-grid" id="mainGrid"></div>
        </div>

        <!-- ADMIN VIEW -->
        <div class="view" id="v-admin" style="padding:0;overflow:hidden;max-height:none">
          <div class="adm-layout-wrap">
            <!-- Vertical tabs sidebar -->
            <div class="adm-sidebar-box">
              <div class="adm-nav">
                <div class="adm-tab on" onclick="admTab('dash',this)">üìä &nbsp;Dashboard</div>
                <div class="adm-tab" onclick="admTab('menu',this)">üìã &nbsp;Menu Items</div>
                <div class="adm-tab" onclick="admTab('extra',this)">üóÇÔ∏è &nbsp;Sub-Views</div>
                <div class="adm-tab" onclick="admTab('users',this)">üîê &nbsp;Security</div>
              </div>
            </div>
            <!-- Content panels -->
            <div class="adm-body-box">
              <div id="as-dash" class="adm-sec on">
                <div class="adm-sec-title">Dashboard</div>
                <div class="adm-sec-sub">Overview of your app content</div>
                <div class="stat-grid">
                  <div class="stat-card"><div class="stat-num" id="stMenu">‚Äî</div><div class="stat-lbl">Menu Items</div></div>
                  <div class="stat-card"><div class="stat-num" id="stSub">‚Äî</div><div class="stat-lbl">Sub-Views</div></div>
                  <div class="stat-card"><div class="stat-num">2</div><div class="stat-lbl">Users</div></div>
                </div>
                <div class="save-banner">
                  <div style="font-size:20px;flex-shrink:0">üî•</div>
                  <div><strong>Auto-Save Active</strong><span>Every change saves to Firebase instantly. All interns see updates immediately ‚Äî no file needed.</span></div>
                </div>
                <div style="display:flex;gap:10px">
                  <button class="btn btn-p btn-sm" onclick="openItemModal()">Ôºã New Menu Item</button>
                  <button class="btn btn-g btn-sm" onclick="openExtraModal()">Ôºã New Sub-View</button>
                </div>
              </div>
              <div id="as-menu" class="adm-sec">
                <div class="adm-sec-title">Menu Items</div>
                <div class="adm-sec-sub">The cards shown on the intern home screen</div>
                <button class="btn btn-p btn-sm" style="margin-bottom:16px" onclick="openItemModal()">Ôºã New Menu Item</button>
                <div id="admMenuList"></div>
              </div>
              <div id="as-extra" class="adm-sec">
                <div class="adm-sec-title">Sub-Views</div>
                <div class="adm-sec-sub">Linked sub-pages accessed via buttons</div>
                <button class="btn btn-p btn-sm" style="margin-bottom:16px" onclick="openExtraModal()">Ôºã New Sub-View</button>
                <div id="admExtraList"></div>
              </div>
              <div id="as-users" class="adm-sec">
                <div class="adm-sec-title">Security</div>
                <div class="adm-sec-sub">Manage account passwords</div>
                <div class="hash-note">üîê Passwords are stored as <strong>SHA-256 hashes</strong> in Firebase. Nobody can read the actual password ‚Äî only the correct password will match.</div>
                <div class="sec-box">
                  <div class="sec-box-title">üë§ Admin Account</div>
                  <div class="field" style="margin-bottom:10px"><label>Username</label><input value="admin" readonly style="opacity:.5"></div>
                  <div class="field" style="margin-bottom:12px"><label>New Password</label><input id="sec-ap" type="password" placeholder="Enter new password"></div>
                  <button class="btn btn-p btn-sm" onclick="updatePw('admin','sec-ap')">Update Admin Password</button>
                </div>
                <div class="sec-box">
                  <div class="sec-box-title">üë§ Intern Account</div>
                  <div class="field" style="margin-bottom:10px"><label>Username</label><input value="intern" readonly style="opacity:.5"></div>
                  <div class="field" style="margin-bottom:12px"><label>New Password</label><input id="sec-ip" type="password" placeholder="Leave blank = no password required"></div>
                  <button class="btn btn-p btn-sm" onclick="updatePw('intern','sec-ip')">Update Intern Password</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div><!-- /card -->
    </div><!-- /shell -->
  </div><!-- /appMain -->

</div><!-- /appShell -->

<!-- Modals ‚Äî same structure, just updated styling via CSS above -->
<div class="modal-bg" id="m-item">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="mItemTitle">Create Menu Item</div>
    <input type="hidden" id="mi-idx">
    <div style="display:grid;grid-template-columns:72px 1fr;gap:10px;margin-bottom:14px">
      <div class="field" style="margin:0"><label>Icon</label><input id="mi-icon" placeholder="üíª" maxlength="4"></div>
      <div class="field" style="margin:0"><label>Title</label><input id="mi-title" placeholder="Hardware Request"></div>
    </div>
    <div class="field"><label>View ID <span style="font-weight:500;color:var(--muted);text-transform:none;font-size:.78rem">(unique, no spaces ‚Äî e.g. hw-1)</span></label><input id="mi-vid" style="font-family:'JetBrains Mono',monospace"></div>
    <div style="font-size:.7rem;font-weight:700;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">Content Blocks</div>
    <div class="btp" id="btpItem"></div>
    <div id="bfeItem"></div>
    <button class="btn btn-s btn-sm" id="addBlkItem" style="margin-bottom:12px">Ôºã Add Block</button>
    <div class="blk-editor" id="blkEditorItem"><div class="blk-empty">No blocks yet. Select a type above and click Add Block.</div></div>
    <div class="prev-lbl">Live Preview</div>
    <div class="prev-box" id="prevItem"></div>
    <div style="display:flex;gap:10px;margin-top:18px">
      <button class="btn btn-g btn-sm" onclick="closeModal('m-item')">Cancel</button>
      <button class="btn btn-p btn-sm" style="flex:1" onclick="saveItem()">Save to Firebase ‚òÅÔ∏è</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="m-extra">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="mExtraTitle">Create Sub-View</div>
    <input type="hidden" id="ex-key">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
      <div class="field" style="margin:0"><label>Label</label><input id="ex-lbl" placeholder="Hardware Step 2"></div>
      <div class="field" style="margin:0"><label>View ID</label><input id="ex-vid" placeholder="hw-2" style="font-family:'JetBrains Mono',monospace"></div>
    </div>
    <div style="font-size:.7rem;font-weight:700;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">Content Blocks</div>
    <div class="btp" id="btpExtra"></div>
    <div id="bfeExtra"></div>
    <button class="btn btn-s btn-sm" id="addBlkExtra" style="margin-bottom:12px">Ôºã Add Block</button>
    <div class="blk-editor" id="blkEditorExtra"><div class="blk-empty">No blocks yet. Select a type above and click Add Block.</div></div>
    <div class="prev-lbl">Live Preview</div>
    <div class="prev-box" id="prevExtra"></div>
    <div style="display:flex;gap:10px;margin-top:18px">
      <button class="btn btn-g btn-sm" onclick="closeModal('m-extra')">Cancel</button>
      <button class="btn btn-p btn-sm" style="flex:1" onclick="saveExtra()">Save to Firebase ‚òÅÔ∏è</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="m-confirm">
  <div class="modal" style="max-width:440px">
    <div class="modal-handle"></div>
    <div class="confirm-body">
      <div style="font-size:40px;margin-bottom:12px" id="cIcon">‚ö†Ô∏è</div>
      <div style="font-size:1rem;font-weight:700;color:var(--ink);margin-bottom:8px" id="cTitle"></div>
    </div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-g btn-sm" style="flex:1" onclick="closeModal('m-confirm')">Cancel</button>
      <button class="btn btn-r btn-sm" style="flex:1" id="cOk">Confirm</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="m-block">
  <div class="modal" style="max-width:540px">
    <div class="modal-handle"></div>
    <div class="modal-title">Edit Block</div>
    <div id="blkEditForm"></div>
    <div style="display:flex;gap:10px;margin-top:14px">
      <button class="btn btn-g btn-sm" onclick="closeModal('m-block')">Cancel</button>
      <button class="btn btn-p btn-sm" style="flex:1" onclick="saveBlkEdit()">Update Block</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Layout adapter ‚Äî runs AFTER module JS, hooks into existing functions -->
<script>
(function(){
  // Wait for showView to be defined by the module, then patch it
  function patchShowView(){
    const orig = window.showView;
    window.showView = function(id){
      orig(id);
      const isLogin = (id === 'login');
      // Toggle topbar + sidebar
      const topbar = document.getElementById('appTopbar');
      const sidebar = document.getElementById('appSidebar');
      const main = document.getElementById('appMain');
      if(topbar) topbar.style.display = isLogin ? 'none' : 'flex';
      if(sidebar) sidebar.style.display = isLogin ? 'none' : 'block';
      if(main){
        main.style.position = isLogin ? '' : 'fixed';
        main.style.top = isLogin ? '' : '58px';
        main.style.left = isLogin ? '' : '220px';
        main.style.right = isLogin ? '' : '0';
        main.style.bottom = isLogin ? '' : '0';
        main.style.overflowY = isLogin ? '' : 'auto';
        main.style.padding = isLogin ? '0' : '32px 40px';
        main.style.background = isLogin ? '' : '#eef2f7';
      }
      // Sidebar active state
      document.querySelectorAll('.snav-btn').forEach(b => b.classList.remove('active'));
      const activeBtn = document.querySelector('.snav-btn[data-nav="'+id+'"]');
      if(activeBtn) activeBtn.classList.add('active');
      // Wrap dynView content in styled card
      if(!['login','main','admin'].includes(id)){
        const el = document.getElementById('v-' + id);
        if(el && !el.dataset.wrapped){
          el.dataset.wrapped = '1';
          el.innerHTML = '<div class="content-card">' + el.innerHTML + '</div>';
          el.querySelectorAll('button[data-view]').forEach(btn => {
            btn.addEventListener('click', () => window.showView(btn.getAttribute('data-view')));
          });
        }
      }
    };
  }

  // Rebuild sidebar items from mainGrid after renderMainMenu runs
  function buildSidebar(){
    const sb = document.getElementById('sidebarItems');
    if(!sb) return;
    sb.innerHTML = '';
    document.querySelectorAll('#mainGrid .menu-card').forEach(card => {
      const icon = card.querySelector('.menu-card-icon')?.textContent || '';
      const title = card.querySelector('.menu-card-title')?.textContent || '';
      const btn = document.createElement('button');
      btn.className = 'snav-btn';
      btn.innerHTML = '<div class="snav-icon">' + icon + '</div>' + title;
      btn.onclick = () => card.click();
      sb.appendChild(btn);
    });
    // Admin button visibility
    if(window.CU === 'admin'){
      const ab = document.getElementById('sidebarAdminBtn');
      if(ab) ab.style.display = 'flex';
    }
  }

  // Observe mainGrid for changes
  const observer = new MutationObserver(buildSidebar);

  // Wait for DOM then start
  function init(){
    const mg = document.getElementById('mainGrid');
    if(mg) observer.observe(mg, { childList: true });

    // Poll for showView to be ready (module loads async)
    const iv = setInterval(() => {
      if(typeof window.showView === 'function'){
        clearInterval(iv);
        patchShowView();
      }
    }, 20);
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>


<script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import{getDatabase,ref,get,set,onValue}from'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';

// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
function getCfg(){try{return JSON.parse(localStorage.getItem('ibCfg')||'null');}catch{return null;}}
function setCfg(c){localStorage.setItem('ibCfg',JSON.stringify(c));}

// ‚îÄ‚îÄ SHA-256 ‚îÄ‚îÄ
async function sha256(s){
  if(!s)return'';
  const b=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(s));
  return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('');
}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let DB=null,CU=null;
let D={menuItems:[],extraViews:{},users:{}};
const MS={
  item:{blocks:[],editIdx:null,blkEditIdx:null,_curType:null,_curUid:null},
  extra:{blocks:[],editKey:null,blkEditIdx:null,_curType:null,_curUid:null}
};

const BT=[
  {id:'heading',ico:'H‚ÇÅ',lbl:'Heading'},
  {id:'text',ico:'¬∂',lbl:'Text'},
  {id:'step',ico:'‚úì',lbl:'Step'},
  {id:'alert',ico:'‚ö†',lbl:'Alert'},
  {id:'link',ico:'üîó',lbl:'Link'},
  {id:'button',ico:'‚ñ∂',lbl:'Button'},
  {id:'contact',ico:'üë§',lbl:'Contact'},
  {id:'code',ico:'</>',lbl:'Code'},
  {id:'nav',ico:'‚Üê‚Üí',lbl:'Nav'},
  {id:'image',ico:'üñº',lbl:'Image'},
];
const BFTITLES={heading:'Heading Block',text:'Text Block',step:'Step Block',alert:'Alert Block',link:'Link Block',button:'Button Block',contact:'Contact Block',code:'Code Block',nav:'Navigation Button',image:'Image Block'};

// ‚îÄ‚îÄ DEFAULT DATA ‚îÄ‚îÄ
const DEFAULTS={
  menuItems:[
    {icon:'üíª',title:'Hardware Request',viewId:'hw-1',content:'<h3 class="block-heading">1. Contact Senior</h3><p class="block-text">Share ticket number with your senior before proceeding.</p><button class="btn btn-p" data-view="hw-2">Next: Headcount Type ‚Üí</button><button class="btn btn-g" data-view="main">‚Üê Back</button>'},
    {icon:'üì±',title:'Roaming Request',viewId:'ro-1',content:'<h3 class="block-heading">Roaming Verification</h3><p class="block-text">Select your carrier to begin activation:</p><button class="btn btn-p" data-view="ro-maxis">012 ‚Äî Maxis</button><button class="btn btn-g" data-view="ro-celcom">019 ‚Äî Celcom</button><button class="btn btn-g" data-view="main">‚Üê Back</button>'},
    {icon:'üîç',title:'Inspection Room',viewId:'in-1',content:'<h3 class="block-heading">Inspection Checklist</h3><div class="instruction-step">‚úÖ Check: TV, Docking Display, Sound, Charging, Camera.</div><button class="btn btn-p" data-view="main">‚Üê Back to Main Menu</button>'},
    {icon:'üõ†Ô∏è',title:'Troubleshoot Laptop',viewId:'ts-menu',content:'<h3 class="block-heading">Common Problems</h3><p class="block-text">Select the issue you are troubleshooting:</p><button class="btn btn-g" data-view="ts-power">‚ö° Charging / Power</button><button class="btn btn-g" data-view="ts-lag">üêå Lagging / Slow</button><button class="btn btn-g" data-view="ts-heat">üå°Ô∏è Overheating</button><button class="btn btn-g" data-view="ts-battery">üîã Battery Issues</button><button class="btn btn-g" data-view="ts-blue">üíÄ Blue Screen (BSOD)</button><button class="btn btn-p" data-view="main">‚Üê Back to Main Menu</button>'},
    {icon:'üìÖ',title:'Event Setup',viewId:'ev-menu',content:'<h3 class="block-heading">Select Location</h3><button class="btn btn-g" data-view="ev-soon">üè¢ Level 14</button><button class="btn btn-g" data-view="ev-soon">üè¢ Level 17</button><button class="btn btn-g" data-view="ev-soon">üèôÔ∏è Level 5 Pinnacle</button><button class="btn btn-p" data-view="main">‚Üê Back to Main Menu</button>'}
  ],
  extraViews:{
    'hw-2':{label:'Hardware ‚Äî Step 2',content:'<h3 class="block-heading">2. Headcount & Assets</h3><p class="block-text">Contractor: G8, G9 | Permanent: G9‚ÄìG12</p><button class="btn btn-p" data-view="hw-3">Device Available ‚Üí Next</button><button class="btn btn-g" data-view="main">‚Üê Back</button>'},
    'hw-3':{label:'Hardware ‚Äî Step 3',content:'<h3 class="block-heading">3. Sticky Note</h3><div class="instruction-step">Write User ID, Email, and Temp Password on a note.</div><button class="btn btn-p" data-view="hw-4">Next: Setup Google ‚Üí</button><button class="btn btn-g" data-view="main">‚Üê Back</button>'},
    'hw-4':{label:'Hardware ‚Äî Step 4',content:'<h3 class="block-heading">4. Account Setup</h3><div class="instruction-step">Login to laptop ‚Üí Sign in Google Chrome ‚Üí Sign in Google Drive</div><button class="btn btn-p" data-view="hw-5">Next: Bookmarks ‚Üí</button><button class="btn btn-g" data-view="main">‚Üê Back</button>'},
    'hw-5':{label:'Hardware ‚Äî Step 5',content:'<h3 class="block-heading">5. Bookmarks</h3><div class="instruction-step">Enable Bookmark Bar ‚Üí Show Bookmarks</div><button class="btn btn-p" data-view="hw-6">Next: Software ‚Üí</button><button class="btn btn-g" data-view="main">‚Üê Back</button>'},
    'hw-6':{label:'Hardware ‚Äî Step 6',content:'<h3 class="block-heading">6. Software Center</h3><div class="instruction-step">Install: HP Universal Printing & MyQ Desktop</div><button class="btn btn-p" data-view="hw-7">Next: Policy ‚Üí</button><button class="btn btn-g" data-view="main">‚Üê Back</button>'},
    'hw-7':{label:'Hardware ‚Äî Step 7',content:'<h3 class="block-heading">7. Policy Update</h3><p class="block-text">Run CMD as administrator:</p><div class="block-code">gpupdate /force</div><button class="btn btn-p" data-view="hw-8">Next: Config Manager ‚Üí</button><button class="btn btn-g" data-view="main">‚Üê Back</button>'},
    'hw-8':{label:'Hardware ‚Äî Step 8',content:'<h3 class="block-heading">8. Control Panel</h3><p class="block-text">Configuration Manager ‚Üí Actions</p><div class="instruction-step">Run: Application Deployment Evaluation Cycle</div><button class="btn btn-p" data-view="hw-9">Next: Prepare Bag ‚Üí</button><button class="btn btn-g" data-view="main">‚Üê Back</button>'},
    'hw-9':{label:'Hardware ‚Äî Step 9',content:'<h3 class="block-heading">9. Final ‚Äî Prepare Bag</h3><div class="instruction-step">‚úÖ Laptop ‚úÖ Charger ‚úÖ Mouse ‚úÖ Wired Headset</div><button class="btn btn-p" data-view="main">üéâ All Done!</button>'},
    'ro-maxis':{label:'Roaming ‚Äî Maxis',content:'<h3 class="block-heading">Maxis Hub Activation</h3><a href="https://businesshub.maxis.com.my/auth/sso" target="_blank" class="link-card">üì° Open Maxis Business Hub</a><div class="instruction-step">Paste number and activate. Choose correct date.</div><button class="btn btn-p" data-view="ro-sheet">Next: Update Sheet ‚Üí</button><button class="btn btn-g" data-view="main">‚Üê Back</button>'},
    'ro-celcom':{label:'Roaming ‚Äî Celcom',content:'<h3 class="block-heading">Celcom BizCare Activation</h3><a href="https://bizcare.celcom.com.my/bizcareui" target="_blank" class="link-card">üì° Open Celcom BizCare</a><div class="instruction-step">Choose company pic. Can be done 1 day early.</div><button class="btn btn-p" data-view="ro-sheet">Next: Update Sheet ‚Üí</button><button class="btn btn-g" data-view="main">‚Üê Back</button>'},
    'ro-sheet':{label:'Roaming ‚Äî Spreadsheet',content:'<h3 class="block-heading">Update Spreadsheet</h3><a href="https://docs.google.com/spreadsheets/d/1y49wP5__FdenXJj3D9H3zE1vyZ6pBwh6SLvcBuBMSoo/edit" target="_blank" class="link-card">üìã Roaming Spreadsheet</a><button class="btn btn-p" data-view="main">‚úÖ Close Ticket & Finish</button>'},
    'ev-soon':{label:'Event ‚Äî Coming Soon',content:'<h3 class="block-heading">Coming Soon</h3><div class="instruction-step">Setup instructions will be added soon.</div><button class="btn btn-p" data-view="ev-menu">‚Üê Back to Locations</button>'},
    'ts-power':{label:'TS ‚Äî Power',content:'<h3 class="block-heading">Charging / Power Issue</h3><div class="instruction-step"><strong>Power Drain:</strong> Unplug everything. Long press Power 30 sec.</div><a href="https://support.hp.com" target="_blank" class="link-card">üîß HP Support Portal</a><button class="btn btn-g" data-view="ts-menu">‚Üê Back</button>'},
    'ts-lag':{label:'TS ‚Äî Lagging',content:'<h3 class="block-heading">Lagging / Slow</h3><button class="btn btn-p" data-view="ts-lag-1">Start Step-by-Step ‚Üí</button><button class="btn btn-g" data-view="ts-menu">‚Üê Cancel</button>'},
    'ts-lag-1':{label:'TS ‚Äî Lag Step 1',content:'<h3 class="block-heading">Step 1: Clear Cache</h3><div class="instruction-step">Clear Temp files and Browser Cache.</div><button class="btn btn-p" data-view="ts-lag-2">Done ‚Üí Next Step</button><button class="btn btn-g" data-view="ts-menu">‚Üê Back</button>'},
    'ts-lag-2':{label:'TS ‚Äî Lag Step 2',content:'<h3 class="block-heading">Step 2: Updates</h3><div class="instruction-step">Update BIOS and Google Chrome.</div><button class="btn btn-p" data-view="ts-menu">‚úÖ Finish</button>'},
    'ts-heat':{label:'TS ‚Äî Overheating',content:'<h3 class="block-heading">Overheating</h3><a href="https://support.hp.com" target="_blank" class="link-card">üîß Check Warranty / Report Case</a><button class="btn btn-g" data-view="ts-menu">‚Üê Back</button>'},
    'ts-battery':{label:'TS ‚Äî Battery',content:'<h3 class="block-heading">Battery Problems</h3><div class="senior-alert">‚ö†Ô∏è REQUIRES SENIOR PERMISSION</div><button class="btn btn-g" data-view="ts-menu">‚Üê Back</button>'},
    'ts-blue':{label:'TS ‚Äî BSOD',content:'<h3 class="block-heading">Blue Screen (BSOD)</h3><div class="senior-alert">‚ö†Ô∏è GET SENIOR PERMISSION BEFORE REFORMAT</div><button class="btn btn-g" data-view="ts-menu">‚Üê Back</button>'}
  }
};

// ‚îÄ‚îÄ FIREBASE INIT ‚îÄ‚îÄ
async function initFirebase(){
  const cfg=getCfg();
  if(!cfg){showConfig();return;}
  try{
    const app=initializeApp({apiKey:cfg.key,authDomain:cfg.pid+'.firebaseapp.com',databaseURL:cfg.url,projectId:cfg.pid,storageBucket:cfg.pid+'.appspot.com'});
    DB=getDatabase(app);
        await loadData();
    document.getElementById('loadingScreen').style.display='none';
    document.getElementById('appShell').style.display='block';
    showView('login');
    buildBtpGrids();
    // Live listener - updates app when another admin saves
    onValue(ref(DB,'appData'),snap=>{
      if(snap.exists()&&CU){
        const raw=snap.val();
        D.menuItems=raw.menuItems?Object.values(raw.menuItems):[];
        D.extraViews=raw.extraViews||{};
        D.users=raw.users||{};
        renderDynViews();renderMainMenu();
        if(CU==='admin'){renderAdmMenuList();renderAdmExtraList();updateStats();}
      }
    });
  }catch(e){
    console.error(e);
    showConfig('Connection failed. Check your config values and try again.');
  }
}

function showConfig(err){
  document.getElementById('loadingScreen').style.display='none';
  document.getElementById('configScreen').style.display='flex';
  if(err){const el=document.getElementById('cfg-err');el.textContent=err;el.style.display='block';}
}

window.saveConfig=function(){
  const url=document.getElementById('cfg-url').value.trim();
  const key=document.getElementById('cfg-key').value.trim();
  const pid=document.getElementById('cfg-pid').value.trim();
  if(!url||!key||!pid){document.getElementById('cfg-err').style.display='block';return;}
  setCfg({url,key,pid});
  document.getElementById('configScreen').style.display='none';
  document.getElementById('loadingScreen').style.display='flex';
  initFirebase();
};

// ‚îÄ‚îÄ DATA LOAD ‚îÄ‚îÄ
async function loadData(){
  const snap=await get(ref(DB,'appData'));
  if(snap.exists()){
    const raw=snap.val();
    D.menuItems=raw.menuItems?Object.values(raw.menuItems):[];
    D.extraViews=raw.extraViews||{};
    D.users=raw.users||{};
  }else{
    // First run ‚Äî seed defaults with hashed passwords
    const ah=await sha256('112233');
    const ih=await sha256('');
    D=JSON.parse(JSON.stringify(DEFAULTS));
    D.users={admin:{hash:ah},intern:{hash:ih}};
    await set(ref(DB,'appData'),{
      menuItems:D.menuItems.reduce((a,v,i)=>(a[i]=v,a),{}),
      extraViews:D.extraViews,
      users:D.users
    });
  }
}

// ‚îÄ‚îÄ FIREBASE WRITE ‚îÄ‚îÄ
function showSaving(){const p=document.getElementById('savingPill');p.classList.add('show');setTimeout(()=>p.classList.remove('show'),1800);}
async function fbWrite(path,val){showSaving();await set(ref(DB,path),val);}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
window.doLogin=async function(){
  const u=document.getElementById('l-user').value.trim().toLowerCase();
  const p=document.getElementById('l-pass').value;
  const rec=D.users[u];
  if(!rec){showLoginErr();return;}
  const h=await sha256(p);
  if(rec.hash!==h){showLoginErr();return;}
  CU=u;
  document.getElementById('loginErr').style.display='none';
  document.getElementById('l-pass').value='';
  document.getElementById('hdrRight').innerHTML='<button class="logout-btn" onclick="doLogout()">'+u+' ¬∑ Sign Out</button>';
  renderMainMenu();renderDynViews();
  if(u==='admin'){renderAdmMenuList();renderAdmExtraList();updateStats();showView('admin');}
  else showView('main');
};
function showLoginErr(){document.getElementById('loginErr').style.display='block';}
window.doLogout=function(){
  CU=null;
  document.getElementById('hdrRight').innerHTML='<span class="hdr-badge">v5 ¬∑ Firebase</span>';
  document.getElementById('l-user').value='';
  showView('login');
};

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
window.showView=function(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  const el=document.getElementById('v-'+id);
  if(el)el.classList.add('active');
  const map={login:'Welcome Back',main:'Operations Hub',admin:'Admin Panel'};
  document.getElementById('hTitle').textContent=map[id]||(()=>{
    const mi=D.menuItems.find(x=>x.viewId===id);
    if(mi)return mi.title;
    if(D.extraViews[id])return D.extraViews[id].label||id;
    return '';
  })();
};
function wireButtons(el){
  el.querySelectorAll('button[data-view]').forEach(btn=>{
    const t=btn.getAttribute('data-view');
    btn.addEventListener('click',()=>window.showView(t));
  });
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function renderDynViews(){
  const c=document.getElementById('dynViews');c.innerHTML='';
  D.menuItems.forEach(item=>{
    const d=document.createElement('div');d.id='v-'+item.viewId;d.className='view';
    d.innerHTML=item.content;wireButtons(d);c.appendChild(d);
  });
  Object.keys(D.extraViews).forEach(k=>{
    const d=document.createElement('div');d.id='v-'+k;d.className='view';
    d.innerHTML=D.extraViews[k].content;wireButtons(d);c.appendChild(d);
  });
}
function renderMainMenu(){
  const g=document.getElementById('mainGrid');g.innerHTML='';
  D.menuItems.forEach(item=>{
    const b=document.createElement('button');b.className='menu-card';
    b.innerHTML='<span class="menu-card-icon">'+item.icon+'</span><span class="menu-card-title">'+item.title+'</span>';
    b.onclick=()=>showView(item.viewId);g.appendChild(b);
  });
  if(CU==='admin'){
    const ab=document.createElement('button');ab.className='menu-card';
    ab.innerHTML='<span class="menu-card-icon">‚öôÔ∏è</span><span class="menu-card-title">Admin Panel</span>';
    ab.onclick=()=>showView('admin');g.appendChild(ab);
  }
}
function renderAdmMenuList(){
  const c=document.getElementById('admMenuList');c.innerHTML='';
  if(!D.menuItems.length){c.innerHTML='<div class="blk-empty">No menu items yet.</div>';return;}
  D.menuItems.forEach((item,i)=>{
    const row=document.createElement('div');row.className='adm-list-item';
    row.innerHTML='<div class="adm-item-icon">'+item.icon+'</div>'
      +'<div class="adm-item-info"><div class="adm-item-title">'+item.title+'</div><div class="adm-item-id">'+item.viewId+'</div></div>'
      +'<div class="adm-item-acts"></div>';
    const acts=row.querySelector('.adm-item-acts');
    const eb=document.createElement('button');eb.className='act-btn';eb.textContent='‚úè';
    eb.onclick=()=>openItemModal(i);acts.appendChild(eb);
    const db=document.createElement('button');db.className='act-btn del';db.textContent='‚úï';
    db.onclick=()=>confirm2('Delete "'+item.title+'"?','üóëÔ∏è',async()=>{
      D.menuItems.splice(i,1);
      await fbWrite('appData/menuItems',D.menuItems.reduce((a,v,i)=>(a[i]=v,a),{}));
      renderMainMenu();renderDynViews();renderAdmMenuList();updateStats();toast('Deleted');
    },'Delete');
    acts.appendChild(db);c.appendChild(row);
  });
}
function renderAdmExtraList(){
  const c=document.getElementById('admExtraList');c.innerHTML='';
  const keys=Object.keys(D.extraViews);
  if(!keys.length){c.innerHTML='<div class="blk-empty">No sub-views yet.</div>';return;}
  keys.forEach(k=>{
    const v=D.extraViews[k];
    const row=document.createElement('div');row.className='adm-list-item';
    row.innerHTML='<div class="adm-item-icon" style="background:linear-gradient(135deg,#d1fae5,#a7f3d0);font-size:11px;font-weight:700;color:#065f46">SV</div>'
      +'<div class="adm-item-info"><div class="adm-item-title">'+(v.label||k)+'</div><div class="adm-item-id">'+k+'</div></div>'
      +'<div class="adm-item-acts"></div>';
    const acts=row.querySelector('.adm-item-acts');
    const eb=document.createElement('button');eb.className='act-btn';eb.textContent='‚úè';
    eb.onclick=()=>openExtraModal(k);acts.appendChild(eb);
    const db=document.createElement('button');db.className='act-btn del';db.textContent='‚úï';
    db.onclick=()=>confirm2('Delete "'+k+'"?','üóëÔ∏è',async()=>{
      delete D.extraViews[k];
      await fbWrite('appData/extraViews',D.extraViews);
      renderDynViews();renderAdmExtraList();updateStats();toast('Deleted');
    },'Delete');
    acts.appendChild(db);c.appendChild(row);
  });
}
function updateStats(){
  document.getElementById('stMenu').textContent=D.menuItems.length;
  document.getElementById('stSub').textContent=Object.keys(D.extraViews).length;
}

// ‚îÄ‚îÄ ADMIN TABS ‚îÄ‚îÄ
window.admTab=function(id,el){
  document.querySelectorAll('.adm-tab').forEach(t=>t.classList.remove('on'));
  document.querySelectorAll('.adm-sec').forEach(s=>s.classList.remove('on'));
  el.classList.add('on');
  document.getElementById('as-'+id).classList.add('on');
};

// ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ
window.openModal=id=>document.getElementById(id).classList.add('open');
window.closeModal=id=>document.getElementById(id).classList.remove('open');
document.querySelectorAll('.modal-bg').forEach(bg=>bg.addEventListener('click',e=>{if(e.target===bg)bg.classList.remove('open');}));

window.openItemModal=function(idx){
  MS.item.editIdx=idx!==undefined?idx:null;MS.item.blkEditIdx=null;MS.item._curType=null;
  const isEdit=idx!==undefined;
  document.getElementById('mItemTitle').textContent=isEdit?'Edit Menu Item':'Create Menu Item';
  document.getElementById('mi-idx').value=isEdit?idx:'';
  document.getElementById('mi-icon').value=isEdit?D.menuItems[idx].icon:'';
  document.getElementById('mi-title').value=isEdit?D.menuItems[idx].title:'';
  document.getElementById('mi-vid').value=isEdit?D.menuItems[idx].viewId:'';
  document.getElementById('mi-vid').readOnly=isEdit;
  document.getElementById('mi-vid').style.opacity=isEdit?'.5':'1';
  // Load existing blocks so they can be edited
  const existingBlocks=isEdit?(D.menuItems[idx].blocks||[]):[];
  MS.item.blocks=JSON.parse(JSON.stringify(existingBlocks));
  document.getElementById('bfeItem').innerHTML='';
  document.querySelectorAll('#btpItem .btp-btn').forEach(b=>b.classList.remove('sel'));
  if(isEdit&&existingBlocks.length){
    renderBlkList('item');updatePreview('item');
  }else if(isEdit&&!existingBlocks.length){
    // Legacy content ‚Äî show preview only, no blocks
    const prev=document.getElementById('prevItem');
    prev.innerHTML=D.menuItems[idx].content;wireButtons(prev);
    document.getElementById('blkEditorItem').innerHTML='<div class="blk-empty" style="color:var(--slate);font-size:.78rem">‚ÑπÔ∏è This item has legacy content. Add new blocks above to replace it.</div>';
  }else{
    document.getElementById('prevItem').innerHTML='';
    document.getElementById('blkEditorItem').innerHTML='<div class="blk-empty">No blocks yet. Select a type above.</div>';
  }
  openModal('m-item');
};
window.openExtraModal=function(key){
  MS.extra.blocks=[];MS.extra.editKey=key||null;MS.extra.blkEditIdx=null;MS.extra._curType=null;
  document.getElementById('mExtraTitle').textContent=key?'Edit Sub-View':'Create Sub-View';
  document.getElementById('ex-key').value=key||'';
  const vidEl=document.getElementById('ex-vid'),prev=document.getElementById('prevExtra'),ed=document.getElementById('blkEditorExtra');
  if(key){
    document.getElementById('ex-lbl').value=D.extraViews[key].label||key;
    vidEl.value=key;vidEl.readOnly=true;vidEl.style.opacity='.5';
    const existingExtraBlocks=D.extraViews[key].blocks||[];
    MS.extra.blocks=JSON.parse(JSON.stringify(existingExtraBlocks));
    prev.innerHTML=D.extraViews[key].content;wireButtons(prev);
    if(existingExtraBlocks.length){renderBlkList('extra');updatePreview('extra');}
    else{ed.innerHTML='<div class="blk-empty" style="color:var(--slate)">No blocks saved ‚Äî add blocks below to build this page.</div>';}
  }else{
    document.getElementById('ex-lbl').value='';
    vidEl.value='';vidEl.readOnly=false;vidEl.style.opacity='1';
    prev.innerHTML='';ed.innerHTML='<div class="blk-empty">No blocks yet.</div>';
  }
  document.getElementById('bfeExtra').innerHTML='';
  document.querySelectorAll('#btpExtra .btp-btn').forEach(b=>b.classList.remove('sel'));
  openModal('m-extra');
};

// ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ
window.saveItem=async function(){
  const icon=document.getElementById('mi-icon').value.trim();
  const title=document.getElementById('mi-title').value.trim();
  const idx=document.getElementById('mi-idx').value;
  const isEdit=idx!=='';
  const viewId=isEdit?D.menuItems[parseInt(idx)].viewId:document.getElementById('mi-vid').value.trim().replace(/\s+/g,'-');
  if(!icon||!title||!viewId)return alert('Fill in Icon, Title, and View ID');
  const blocksToSave=MS.item.blocks.length?MS.item.blocks:(isEdit&&D.menuItems[parseInt(idx)].blocks?D.menuItems[parseInt(idx)].blocks:[]);
  const c=blocksToSave.length?blocks2html(blocksToSave):isEdit?D.menuItems[parseInt(idx)].content:'<h3 class="block-heading">'+title+'</h3><button class="btn btn-g" data-view="main">&#x2190; Back</button>';
  const item={icon,title,viewId,content:c,blocks:blocksToSave};
  if(!isEdit)D.menuItems.push(item);else D.menuItems[parseInt(idx)]=item;
  MS.item.blocks=[];
  await fbWrite('appData/menuItems',D.menuItems.reduce((a,v,i)=>(a[i]=v,a),{}));
  closeModal('m-item');renderMainMenu();renderDynViews();renderAdmMenuList();updateStats();
  toast('‚òÅÔ∏è Saved to Firebase!');
};
window.saveExtra=async function(){
  const key=document.getElementById('ex-key').value;
  const isEdit=!!key;
  const vid=isEdit?key:document.getElementById('ex-vid').value.trim().replace(/\s+/g,'-');
  const lbl=document.getElementById('ex-lbl').value.trim();
  if(!vid)return alert('Enter a View ID');
  if(!isEdit&&D.extraViews[vid])return alert('View ID "'+vid+'" already exists.');
  const blocksToSave=MS.extra.blocks.length?MS.extra.blocks:(isEdit&&D.extraViews[key].blocks?D.extraViews[key].blocks:[]);
  const c=blocksToSave.length?blocks2html(blocksToSave):isEdit?D.extraViews[key].content:'<h3 class="block-heading">'+(lbl||vid)+'</h3><button class="btn btn-g" data-view="main">&#x2190; Back</button>';
  D.extraViews[vid]={label:lbl||vid,content:c,blocks:blocksToSave};
  MS.extra.blocks=[];
  document.getElementById('ex-vid').readOnly=false;document.getElementById('ex-vid').style.opacity='1';
  await fbWrite('appData/extraViews',D.extraViews);
  closeModal('m-extra');renderDynViews();renderAdmExtraList();updateStats();
  toast('‚òÅÔ∏è Saved to Firebase!');
};
// ‚îÄ‚îÄ PASSWORD ‚îÄ‚îÄ
window.updatePw=async function(role,inputId){
  const pw=document.getElementById(inputId).value;
  const h=await sha256(pw);
  if(!D.users)D.users={};
  if(!D.users[role])D.users[role]={};
  D.users[role].hash=h;
  await fbWrite('appData/users',D.users);
  document.getElementById(inputId).value='';
  toast('Password updated for '+role);
};

// ‚îÄ‚îÄ RESET ‚îÄ‚îÄ
// reset removed

// ‚îÄ‚îÄ BLOCKS ‚îÄ‚îÄ
function blocks2html(blocks){
  const out=[];
  blocks.forEach(b=>{
    if(b.type==='heading')out.push('<h3 class="block-heading">'+b.text+'</h3>');
    else if(b.type==='text')out.push('<p class="block-text">'+b.content+'</p>');
    else if(b.type==='step')out.push('<div class="instruction-step">'+b.content+'</div>');
    else if(b.type==='alert')out.push('<div class="senior-alert">'+b.msg+'</div>');
    else if(b.type==='link')out.push('<a href="'+b.url+'" target="_blank" class="link-card">'+b.label+'</a>');
    else if(b.type==='button'||b.type==='nav'){
      const cls=b.type==='nav'?(b.style==='primary'?'btn btn-p':'btn btn-g'):(b.style==='red'?'btn btn-r':b.style==='ghost'?'btn btn-g':'btn btn-p');
      const dv=b.target?' data-view="'+b.target+'"':'';
      out.push('<button class="'+cls+'"'+dv+'>'+b.label+'</button>');
    }
    else if(b.type==='contact'){
      const cols=(b.contacts||[]).map(c=>{
        const src='https://ui-avatars.com/api/?name='+encodeURIComponent(c.name)+'&background=4f46e5&color=fff';
        const inner='<img src="'+src+'" alt="'+c.name+'">'+c.name;
        return c.url?'<a href="'+c.url+'" target="_blank" class="senior-box">'+inner+'</a>':'<div class="senior-box">'+inner+'</div>';
      }).join('');
      out.push('<div class="senior-grid">'+cols+'</div>');
    }
    else if(b.type==='code')out.push('<div class="block-code">'+b.content+'</div>');
    else if(b.type==='image'){
      out.push('<img src="'+b.url+'" class="block-image" alt="'+(b.caption||'image')+'" loading="lazy">');
      if(b.caption)out.push('<div class="block-caption">'+b.caption+'</div>');
    }
  });
  return out.join('');
}
function blkPrev(b){
  const e=s=>s?(s+'').replace(/</g,'&lt;').substring(0,40):'';
  if(b.type==='heading')return e(b.text);
  if(['text','step','code'].includes(b.type))return e(b.content);
  if(b.type==='alert')return e(b.msg);
  if(b.type==='link')return e(b.label)+' ‚Üí '+e(b.url);
  if(b.type==='button'||b.type==='nav')return '['+b.style+'] '+e(b.label)+(b.target?' ‚Üí '+b.target:'');
  if(b.type==='contact')return(b.contacts||[]).map(c=>c.name).join(', ');
  if(b.type==='image')return b.url?'üñº '+b.url.substring(0,40)+'‚Ä¶':'üñº Image';
  return'';
}
function updatePreview(editor){
  const id=editor==='extra'?'prevExtra':'prevItem';
  const html=blocks2html(MS[editor].blocks);
  const pane=document.getElementById(id);
  pane.innerHTML=html||'<div style="color:var(--muted);font-size:.82rem">Preview appears here‚Ä¶</div>';
  wireButtons(pane);
}
function renderBlkList(editor){
  const edEl=document.getElementById(editor==='extra'?'blkEditorExtra':'blkEditorItem');
  edEl.innerHTML='';
  const blocks=MS[editor].blocks;
  if(!blocks.length){edEl.innerHTML='<div class="blk-empty">No blocks yet.</div>';return;}
  blocks.forEach((b,i)=>{
    const d=document.createElement('div');d.className='blk-item';
    d.innerHTML='<span class="blk-badge">'+b.type+'</span><span class="blk-prev">'+blkPrev(b)+'</span>';
    const acts=document.createElement('div');acts.className='blk-acts';
    const mk=(cls,icon,fn)=>{const btn=document.createElement('button');btn.className='bact '+cls;btn.textContent=icon;btn.onclick=fn;acts.appendChild(btn);};
    (function(idx,ed){
      mk('',  '‚Üë',()=>{if(idx>0){const bl=MS[ed].blocks;[bl[idx],bl[idx-1]]=[bl[idx-1],bl[idx]];renderBlkList(ed);updatePreview(ed);}});
      mk('',  '‚Üì',()=>{const bl=MS[ed].blocks;if(idx<bl.length-1){[bl[idx],bl[idx+1]]=[bl[idx+1],bl[idx]];renderBlkList(ed);updatePreview(ed);}});
      mk('',  '‚úè',()=>openBlkEdit(idx,ed));
      mk('bad','‚úï',()=>{MS[ed].blocks.splice(idx,1);renderBlkList(ed);updatePreview(ed);});
    })(i,editor);
    d.appendChild(acts);edEl.appendChild(d);
  });
}
function buildBtpGrids(){
  ['Item','Extra'].forEach(cap=>{
    const ed=cap==='Item'?'item':'extra';
    const g=document.getElementById('btp'+cap);g.innerHTML='';
    BT.forEach(bt=>{
      const b=document.createElement('button');b.type='button';b.className='btp-btn';
      b.innerHTML='<span class="ico">'+bt.ico+'</span><span class="lbl">'+bt.lbl+'</span>';
      b.onclick=()=>{g.querySelectorAll('.btp-btn').forEach(x=>x.classList.remove('sel'));b.classList.add('sel');renderBfe(bt.id,ed);};
      g.appendChild(b);
    });
  });
}
function fld(lbl,id,type,ph,mono){
  const ta=type==='textarea';
  const inp=ta?`<textarea id="${id}" placeholder="${ph||''}"${mono?' style="font-family:\'DM Mono\',monospace"':''}></textarea>`:`<input type="${type}" id="${id}" placeholder="${ph||''}"${mono?' style="font-family:\'DM Mono\',monospace"':''}>`;
  return`<label style="font-size:.7rem;font-weight:600;color:var(--slate);display:block;margin-bottom:3px">${lbl}</label>${inp}`;
}
function sfld(lbl,id,opts){
  return`<label style="font-size:.7rem;font-weight:600;color:var(--slate);display:block;margin-bottom:3px">${lbl}</label><select id="${id}">${opts.map(o=>`<option value="${o.split(':')[0]}">${o.split(':')[1]}</option>`).join('')}</select>`;
}
function renderBfe(type,editor){
  const uid=editor==='extra'?'ex':'it';
  const area=document.getElementById(editor==='extra'?'bfeExtra':'bfeItem');area.innerHTML='';
  const wrap=document.createElement('div');wrap.className='bfe';
  let html=`<div class="bfe-title">${BFTITLES[type]}</div>`;
  if(type==='heading')html+=fld('Heading Text',`${uid}-h`,'text','e.g. Step 1: Contact Senior');
  else if(type==='text')html+=fld('Content',`${uid}-t`,'textarea','Enter paragraph text...');
  else if(type==='step')html+=fld('Step Content',`${uid}-s`,'textarea','e.g. Write User ID...');
  else if(type==='alert')html+=fld('Alert Message',`${uid}-a`,'text','e.g. ‚ö†Ô∏è REQUIRES SENIOR PERMISSION');
  else if(type==='link')html+=fld('Label',`${uid}-ll`,'text','e.g. Open Maxis Hub')+fld('URL',`${uid}-lu`,'url','https://...');
  else if(type==='button')html+=fld('Label',`${uid}-bl`,'text','e.g. Next Step ‚Üí')+fld('Target View ID',`${uid}-bt`,'text','e.g. hw-2')+sfld('Style',`${uid}-bs`,['primary:Primary (Purple)','ghost:Ghost (Outline)','red:Red (Danger)']);
  else if(type==='contact')html+=`<div id="${uid}-rows"></div><button type="button" class="btn btn-g btn-sm" style="width:auto" onclick="addCntRow('${uid}-rows')">+ Add Contact</button>`;
  else if(type==='code')html+=fld('Code / Command',`${uid}-c`,'textarea','e.g. gpupdate /force',true);
  else if(type==='nav')html+=fld('Label',`${uid}-nl`,'text','e.g. ‚Üê Back')+fld('Target View ID',`${uid}-nt`,'text','e.g. main')+sfld('Style',`${uid}-ns`,['ghost:Ghost (Outline)','primary:Primary (Purple)']);
  else if(type==='image')html+=`<div class="img-upload-box" onclick="document.getElementById('${uid}-imgfile').click()"><input type="file" id="${uid}-imgfile" accept="image/*" onchange="previewImg('${uid}')"><span id="${uid}-imgicon" style="font-size:28px">üñºÔ∏è</span><div style="font-size:.8rem;color:var(--muted);margin-top:4px">Tap to choose image (max ~2MB)</div><img id="${uid}-imgprev" class="img-preview" style="display:none"><div id="${uid}-imgstatus" style="display:none;font-size:.78rem;color:var(--purple);margin-top:4px;font-weight:600"></div></div><div style="font-size:.72rem;color:var(--muted);margin-top:6px;margin-bottom:4px">Or paste image URL directly:</div>` + fld('Image URL (optional)',`${uid}-imgurl`,'url','https://... or leave blank to upload file') + fld('Caption (optional)',`${uid}-imgcap`,'text','e.g. Server rack diagram');
  wrap.innerHTML=html;area.appendChild(wrap);
  if(type==='contact')addCntRow(`${uid}-rows`);
  MS[editor]._curType=type;MS[editor]._curUid=uid;
}
window.addCntRow=function(rowsId){
  const ctr=document.getElementById(rowsId);if(!ctr)return;
  const row=document.createElement('div');row.className='cnt-row';
  row.innerHTML='<input type="text" class="cnt-name" placeholder="Name"><input type="url" class="cnt-url" placeholder="Chat URL (optional)"><button type="button" class="cnt-del" onclick="this.parentElement.remove()">‚úï</button>';
  ctr.appendChild(row);
};
function gv(id){const e=document.getElementById(id);return e?e.value.trim():'';}
async function commitBlock(type,editor,uid){
  let block=null;
  if(type==='heading'){const t=gv(`${uid}-h`);if(!t)return alert('Enter heading text');block={type,text:t};}
  else if(type==='text'){const c=gv(`${uid}-t`);if(!c)return alert('Enter text');block={type,content:c};}
  else if(type==='step'){const c=gv(`${uid}-s`);if(!c)return alert('Enter step content');block={type,content:c};}
  else if(type==='alert'){const m=gv(`${uid}-a`);if(!m)return alert('Enter alert message');block={type,msg:m};}
  else if(type==='link'){const l=gv(`${uid}-ll`),u=gv(`${uid}-lu`);if(!l||!u)return alert('Fill label and URL');block={type,label:l,url:u};}
  else if(type==='button'){const l=gv(`${uid}-bl`),t=gv(`${uid}-bt`),s=gv(`${uid}-bs`);if(!l)return alert('Enter label');block={type,label:l,target:t,style:s};}
  else if(type==='contact'){
    const ctr=document.getElementById(`${uid}-rows`);if(!ctr)return;
    const contacts=[...ctr.querySelectorAll('.cnt-name')].map((n,i)=>({name:n.value.trim(),url:ctr.querySelectorAll('.cnt-url')[i]?.value.trim()||''})).filter(c=>c.name);
    if(!contacts.length)return alert('Add at least one contact');
    block={type,contacts};
  }
  else if(type==='code'){const c=gv(`${uid}-c`);if(!c)return alert('Enter code');block={type,content:c};}
  else if(type==='nav'){const l=gv(`${uid}-nl`),t=gv(`${uid}-nt`),s=gv(`${uid}-ns`);if(!l)return alert('Enter label');block={type,label:l,target:t,style:s};}
  else if(type==='image'){
    const urlVal=gv(`${uid}-imgurl`);
    const fileEl=document.getElementById(`${uid}-imgfile`);
    const file=fileEl&&fileEl.files&&fileEl.files[0];
    const captionVal=gv(`${uid}-imgcap`)||'';
    if(!urlVal&&!file)return alert('Choose an image file or paste an image URL');
    const status=document.getElementById(`${uid}-imgstatus`);
    if(urlVal){block={type,url:urlVal,caption:captionVal};}
    else{
      if(status){status.style.display='block';status.textContent='‚è≥ Processing...';}
      try{
        await new Promise((resolve,reject)=>{
          const r=new FileReader();
          r.onload=e=>{
            const b64=e.target.result;
            if(b64.length>4*1024*1024){
              reject(new Error('Image too large. Please resize to under 2MB, or paste a URL instead.'));
            }else{
              block={type,url:b64,caption:captionVal};
              resolve();
            }
          };
          r.onerror=()=>reject(new Error('Failed to read file'));
          r.readAsDataURL(file);
        });
        if(status)status.style.display='none';
      }catch(e){
        if(status)status.style.display='none';
        return alert(e.message);
      }
    }
  }
  if(!block)return;
  MS[editor].blocks.push(block);
  renderBlkList(editor);updatePreview(editor);
  document.getElementById(editor==='extra'?'bfeExtra':'bfeItem').innerHTML='';
  document.querySelectorAll('#'+(editor==='extra'?'btpExtra':'btpItem')+' .btp-btn').forEach(b=>b.classList.remove('sel'));
  MS[editor]._curType=null;MS[editor]._curUid=null;
  toast('Block added ‚úì');
}
window.previewImg=function(uid){
  const file=document.getElementById(uid+'-imgfile').files[0];
  if(!file)return;
  const prev=document.getElementById(uid+'-imgprev');
  const icon=document.getElementById(uid+'-imgicon');
  const r=new FileReader();
  r.onload=e=>{prev.src=e.target.result;prev.style.display='block';if(icon)icon.style.display='none';};
  r.readAsDataURL(file);
};
window.addBlock=async function(editor){
  const type=MS[editor]._curType,uid=MS[editor]._curUid;
  if(!type)return alert('Select a block type first');
  await commitBlock(type,editor,uid);
};
function openBlkEdit(i,editor){
  MS[editor].blkEditIdx=i;
  const b=MS[editor].blocks[i];
  const form=document.getElementById('blkEditForm');form.innerHTML='';
  let html='';
  if(b.type==='heading')html=fld('Heading Text','ed-h','text');
  else if(b.type==='text')html=fld('Content','ed-t','textarea');
  else if(b.type==='step')html=fld('Step Content','ed-s','textarea');
  else if(b.type==='alert')html=fld('Alert Message','ed-a','text');
  else if(b.type==='link')html=fld('Label','ed-ll','text')+fld('URL','ed-lu','url');
  else if(b.type==='button')html=fld('Label','ed-bl','text')+fld('Target View ID','ed-bt','text')+sfld('Style','ed-bs',['primary:Primary','ghost:Ghost','red:Red']);
  else if(b.type==='nav')html=fld('Label','ed-nl','text')+fld('Target View ID','ed-nt','text')+sfld('Style','ed-ns',['ghost:Ghost','primary:Primary']);
  else if(b.type==='code')html=fld('Code','ed-c','textarea');
  form.innerHTML=html;form.dataset.editor=editor;
  const sv=(id,val)=>{const el=document.getElementById(id);if(el)el.value=val||'';};
  if(b.type==='heading')sv('ed-h',b.text);
  else if(['text','step','code'].includes(b.type))sv('ed-'+(b.type==='text'?'t':b.type==='step'?'s':'c'),b.content);
  else if(b.type==='alert')sv('ed-a',b.msg);
  else if(b.type==='link'){sv('ed-ll',b.label);sv('ed-lu',b.url);}
  else if(b.type==='button'){sv('ed-bl',b.label);sv('ed-bt',b.target);sv('ed-bs',b.style);}
  else if(b.type==='nav'){sv('ed-nl',b.label);sv('ed-nt',b.target);sv('ed-ns',b.style);}
  else if(b.type==='image'){
    // For image edit, show current image and caption field
    form.innerHTML=`<div style="margin-bottom:10px">
      <label style="font-size:.7rem;font-weight:600;color:var(--slate);display:block;margin-bottom:4px">CURRENT IMAGE</label>
      <img src="${b.url}" style="width:100%;border-radius:8px;margin-bottom:8px;object-fit:cover;max-height:160px">
    </div>` + fld('Caption','ed-imgcap','text') + `<div style="font-size:.72rem;color:var(--muted);margin-bottom:6px">Replace image (optional):</div><div class="img-upload-box" onclick="document.getElementById('ed-imgfile').click()"><input type="file" id="ed-imgfile" accept="image/*" onchange="(function(){const f=document.getElementById('ed-imgfile').files[0];if(!f)return;const r=new FileReader();r.onload=e=>{document.querySelector('#blkEditForm img').src=e.target.result;};r.readAsDataURL(f);})()"><span style="font-size:.8rem;color:var(--muted)">Tap to replace image</span></div>`;
    form.dataset.editor=editor;
    sv('ed-imgcap',b.caption||'');
    openModal('m-block');
    return;
  }
  openModal('m-block');
}
window.saveBlkEdit=async function(){
  const editor=document.getElementById('blkEditForm').dataset.editor;
  const i=MS[editor].blkEditIdx;
  const b=MS[editor].blocks[i];
  if(b.type==='heading')b.text=gv('ed-h');
  else if(b.type==='text')b.content=gv('ed-t');
  else if(b.type==='step')b.content=gv('ed-s');
  else if(b.type==='alert')b.msg=gv('ed-a');
  else if(b.type==='link'){b.label=gv('ed-ll');b.url=gv('ed-lu');}
  else if(b.type==='button'){b.label=gv('ed-bl');b.target=gv('ed-bt');b.style=gv('ed-bs');}
  else if(b.type==='nav'){b.label=gv('ed-nl');b.target=gv('ed-nt');b.style=gv('ed-ns');}
  else if(b.type==='code')b.content=gv('ed-c');
  else if(b.type==='image'){
    b.caption=gv('ed-imgcap');
    const fileEl=document.getElementById('ed-imgfile');
    if(fileEl&&fileEl.files&&fileEl.files[0]){
      await new Promise((resolve,reject)=>{
        const r=new FileReader();
        r.onload=e=>{
          if(e.target.result.length>4*1024*1024){reject(new Error('Image too large (max ~2MB)'));}
          else{b.url=e.target.result;resolve();}
        };
        r.onerror=()=>reject(new Error('Read failed'));
        r.readAsDataURL(fileEl.files[0]);
      }).catch(err=>{alert(err.message);});
    }
  }
  closeModal('m-block');renderBlkList(editor);updatePreview(editor);toast('Block updated ‚úì');
};
function confirm2(msg,icon,onOk,okLabel){
  document.getElementById('cIcon').textContent=icon||'‚ö†Ô∏è';
  document.getElementById('cTitle').textContent=msg;
  const ok=document.getElementById('cOk');ok.textContent=okLabel||'Confirm';
  ok.onclick=()=>{closeModal('m-confirm');onOk();};
  openModal('m-confirm');
}
function toast(msg){
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2200);
}
document.getElementById('addBlkItem').onclick=()=>window.addBlock('item');
document.getElementById('addBlkExtra').onclick=()=>window.addBlock('extra');
document.getElementById('l-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
initFirebase();
</script>
</body>
</html>
